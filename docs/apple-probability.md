# 抽選ロジックの概要

## フロー全体
1. **第1段階: 物々交換優先判定**
   - 70% の確率で即座にブロンズりんご（物々交換）を確定。
   - 残り 30% が第2段階（毒 or 上位りんごチャレンジ）へ進む。
2. **第2段階: 毒 vs 上位トークン**
   - 紹介ボーナス適用後の確率テーブルを使って、毒と上位（銀/金/赤）だけを相対比較。
   - 毒を引いた場合: `apple_reward_bank.upper_tokens` を +1 し、以降の上位抽選が解放される。
   - 上位側に振れた場合: `upper_tokens` から 1 枚消費できたときだけ銀/金/赤の詳細抽選へ進む。トークンが無ければブロンズにフォールバック。
3. **上位りんごの内訳**
   - 銀/金/赤の比率は紹介ボーナス適用後のウェイトに従い、正規化して抽選。

## 100人が抽選したときの目安
| 区分 | 想定人数 | 補足 |
| ---- | -------- | ---- |
| ブロンズ即決 (第1段階) | 約70人 | 物々交換で完了 |
| 第2段階へ進む人数 | 約30人 | 毒 or 上位候補 |
| └ 毒 (例: 40%) | 約12人 | 1人ごとに上位トークン +1 |
| └ 上位当選 (トークン最大12個) | 最大12人 | ゴールド/シルバー/赤のどれか |
| └ トークン不足でブロンズへ戻る | 残り (例:6人) | 上位在庫が無ければブロンズ |

※トークンは毒でしか補充されないため、「誰かが毒を引いた分だけ別の誰かが上位りんごを引ける」仕組みになります。

## データ構造
- `apple_reward_bank`
  - `upper_tokens`: 未消費の上位りんご在庫数
  - `poison_total`: 累計でいくつ毒が発生したかを把握するためのカウンタ
- RPC
  - `apple_reward_add_tokens(amount int)` : 毒発生時に上位トークンを補充
  - `apple_reward_consume_token()` : 上位抽選時に 1 枚消費（在庫ゼロなら false）

## 実装メモ
- 第1段階の 70% はハードコード（`BRONZE_STAGE_RATE`）。調整したい場合は env / setting 化を検討。
- 第2段階では `getPersonalWeights` の結果を使用し、紹介人数ボーナス（毒率減＆上位増）を継続適用。
- トークン消費に成功した後に上位抽選を実施。万が一重みが 0 の場合はブロンズにフォールバックし、必要ならトークンを戻す処理を追加する。
